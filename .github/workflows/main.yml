name: Generate Dependency Badge

on:
  push:
    branches: 
      - master
    paths: ["pom.xml"]
  workflow_dispatch:

jobs:
  setup-maven:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Run Maven
        run: mvn -DoutputFile=mvn_dependency_tree.txt dependency:tree
          
      - name: Setup Python
        uses: actions/setup-python@v2.3.3
        with:
          python-version: '3.8'
          architecture: 'x64'
  
      - name: Run Python
        run: python generate-dependency-badge.py

      - name: Push from GitHub Actions
        run: |
          git remote set-url origin https://github-actions:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          if (git diff --shortstat | grep '[0-9]'); then \
            git add /home/runner/work/ASAP/ASAP/README.md; \
            git commit -m "Push from GitHub Actions"; \
            git push origin HEAD:${GITHUB_REF}; \
          fi
